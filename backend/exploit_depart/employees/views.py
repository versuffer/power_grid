from drf_spectacular.utils import extend_schema
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.viewsets import ModelViewSet

from common.serializers.person import (
    EmployeeDefaultSerializer,
    EmployeeHyperlinkedDetailSerializer,
    EmployeeRetrieveSerializer,
    EmployeeRightsTableSerializer,
    RightDetailSerializer,
    RightHyperlinkedDetailSerializer,
)
from common.views.mixins import MultiSerializerMixin

from .models import Employee, Right


@extend_schema(tags=["Rights"])
class RightViewSet(MultiSerializerMixin, ModelViewSet):
    queryset = Right.objects.prefetch_related("owners").all()
    serializer_class = RightDetailSerializer
    serializer_action_classes = {
        "list": RightHyperlinkedDetailSerializer,
    }

    # def create(self, request, *args, **kwargs):
    #     response = super().create(request, *args, **kwargs)
    #     path = reverse("right-detail", args=[response.data["id"]])
    #     return redirect(path)
    #
    # def update(self, request, *args, **kwargs):
    #     super().update(request, *args, **kwargs)
    #     return redirect(request.path)


@extend_schema(tags=["Employees"])
class EmployeeViewSet(MultiSerializerMixin, ModelViewSet):
    queryset = Employee.objects.prefetch_related("supervisors", "rights").all()
    serializer_class = EmployeeDefaultSerializer
    serializer_action_classes = {
        "list": EmployeeHyperlinkedDetailSerializer,
        "retrieve": EmployeeRetrieveSerializer,
        "list_rights_table": EmployeeRightsTableSerializer,
    }

    @action(methods=["get"], detail=False, url_path="rights-table")
    def list_rights_table(self, request, *args, **kwargs):
        queryset = self.filter_queryset(self.get_queryset())

        page = self.paginate_queryset(queryset)
        if page is not None:
            serializer = self.get_serializer(page, many=True)
            return self.get_paginated_response(serializer.data)

        serializer = self.get_serializer(queryset, many=True)
        return Response(serializer.data)

    # def create(self, request, *args, **kwargs):
    #     response = super().create(request, *args, **kwargs)
    #     path = reverse("employee-detail", args=[response.data["id"]])
    #     return redirect(path)
    #
    # def update(self, request, *args, **kwargs):
    #     super().update(request, *args, **kwargs)
    #     return redirect(request.path)
