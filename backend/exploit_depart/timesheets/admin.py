from django.contrib import admin
from django.db.models import Q

from .models import TimeSheet, WorkDay


@admin.register(WorkDay)
class WorkDayAdmin(admin.ModelAdmin):
    list_display = [field.name for field in WorkDay._meta.get_fields()]


@admin.register(TimeSheet)
class TimeSheetAdmin(admin.ModelAdmin):
    list_display = ["timesheet_name", "period_start", "period_end"]
    filter_horizontal = ["employees", "work_days"]

    def save_related(self, request, form, formsets, change):
        super().save_related(request, form, formsets, change)
        inst = form.instance
        inst.work_days.clear()
        inst.work_days.add(
            *WorkDay.objects.filter(
                Q(employee__in=inst.employees.all())
                & Q(date__gte=inst.period_start)
                & Q(date__lte=inst.period_end)
            )
        )
