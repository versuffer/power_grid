from django.db import models

from common.services.workdays_manager import add_workdays
from employees.models import Employee

from .workdays.models import WorkDay

Q = models.Q
F = models.F


class TimeSheet(models.Model):
    class Meta:
        verbose_name = "Taбель"

    timesheet_name = models.CharField(
        max_length=255, unique=True, null=False, blank=False
    )
    employees = models.ManyToManyField(
        to=Employee,
        related_name="timesheets",
        verbose_name="Работник",
        blank=False,
    )
    workdays = models.ManyToManyField(
        to=WorkDay,
        related_name="timesheets",
        verbose_name="Календарные дни",
        blank=True,
    )
    period_start = models.DateField(
        verbose_name="Начало учётного периода", null=False, blank=False
    )
    period_end = models.DateField(
        verbose_name="Конец учётного периода", null=False, blank=False
    )

    def save(self, *args, **kwargs):
        self.validate_constraints()
        super().save(*args, **kwargs)
        add_workdays(self)
