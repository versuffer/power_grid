from rest_framework.exceptions import ValidationError

from common.base.validators import BaseValidator
from common.data.timesheets import choices
from common.data.timesheets.validation import messages


class WorkDayValidator(BaseValidator):
    def workday_object_validation(self):
        work_started = self.get_from_dict_or_db("work_started")
        work_ended = self.get_from_dict_or_db("work_ended")
        launch_started = self.get_from_dict_or_db("launch_started")
        launch_ended = self.get_from_dict_or_db("launch_ended")

        return self._perform_validation(
            work_started, work_ended, launch_started, launch_ended
        )

    def multiple_workday_object_validation(self):
        def _get_data_or_message(field_name, message_name):
            nonlocal raise_exc_flag
            try:
                return self.data[field_name]
            except KeyError:
                self.error_dict["messages"].append(messages.get(message_name))
                raise_exc_flag = True

        self.error_dict = self.get_default_error_dict()
        raise_exc_flag = False

        work_started = _get_data_or_message("work_started", "work_started_not_filled")
        work_ended = _get_data_or_message("work_ended", "work_ended_not_filled")
        launch_started = _get_data_or_message(
            "launch_started", "launch_started_not_filled"
        )
        launch_ended = _get_data_or_message("launch_ended", "launch_ended_not_filled")

        if raise_exc_flag:
            raise ValidationError(detail=self.error_dict)

        return self._perform_validation(
            work_started, work_ended, launch_started, launch_ended
        )

    def _perform_validation(
        self, work_started, work_ended, launch_started, launch_ended
    ):
        self.error_dict = self.get_default_error_dict()

        if self.data.get("day_status") in [
            choices.weekend,
            choices.sickday,
            choices.vacation,
        ]:
            values = [work_started, work_ended, launch_started, launch_ended]
            for value in values:
                if value is not None:
                    self.error_dict["messages"] = [
                        messages.get("if_weekend_filled_properly")
                    ]
                    raise ValidationError(detail=self.error_dict)
            return self.data

        if None in [work_started, work_ended]:
            self.error_dict["messages"] = [messages.get("if_work_period_filled")]
            raise ValidationError(detail=self.error_dict)

        if not work_started < work_ended:
            self.error_dict["messages"] = [messages.get("work_start_before_end")]
            raise ValidationError(detail=self.error_dict)

        if None not in [launch_started, launch_ended]:
            if not work_started < launch_started < launch_ended < work_ended:
                self.error_dict["messages"] = [messages.get("launch_in_work_period")]
                raise ValidationError(detail=self.error_dict)

        return self.data
